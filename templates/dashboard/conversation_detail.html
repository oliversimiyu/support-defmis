{% extends 'dashboard/base.html' %}

{% block title %}Chat with {{ conversation.customer_name|default:conversation.customer_id }} - Chat Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Chat with {{ conversation.customer_name|default:conversation.customer_id }}</h2>
            <p class="text-muted mb-0">{{ conversation.customer_email|default:"No email provided" }}</p>
        </div>
        <div>
            <span class="badge {% if conversation.status == 'open' %}bg-success{% else %}bg-secondary{% endif %} me-2">
                {{ conversation.get_status_display }}
            </span>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleChatStatus()">
                {% if conversation.status == 'open' %}Close Chat{% else %}Reopen Chat{% endif %}
            </button>
            <a href="{% url 'dashboard:conversations' %}" class="btn btn-sm btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Conversations
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card" style="height: 600px;">
                <div class="card-body d-flex flex-column">
                    <!-- Messages Container -->
                    <div id="messages-container" class="flex-grow-1 overflow-auto mb-3" style="max-height: 450px;">
                        {% for message in messages %}
                        {% if message.sender_type == 'system' %}
                        <div class="d-flex justify-content-center">
                            <div class="message-bubble message-system">
                                <div class="mb-1">{{ message.content }}</div>
                                <small class="opacity-75">{{ message.timestamp|date:"M d, H:i" }}</small>
                            </div>
                        </div>
                        {% else %}
                        <div class="d-flex {% if message.sender_type == 'admin' %}justify-content-end{% else %}justify-content-start{% endif %}">
                            <div class="message-bubble {% if message.sender_type == 'admin' %}message-admin{% else %}message-customer{% endif %}">
                                <div class="mb-1">{{ message.content }}</div>
                                {% if message.attachment %}
                                <div class="mt-2">
                                    {% if message.attachment.url|lower|slice:"-4:" == '.jpg' or message.attachment.url|lower|slice:"-4:" == '.png' or message.attachment.url|lower|slice:"-5:" == '.jpeg' or message.attachment.url|lower|slice:"-4:" == '.gif' or message.attachment.url|lower|slice:"-5:" == '.webp' %}
                                        <a href="{{ message.attachment.url }}" target="_blank">
                                            <img src="{{ message.attachment.url }}" style="max-width: 200px; max-height: 150px; border-radius: 8px; cursor: pointer;" class="img-thumbnail" />
                                        </a>
                                    {% else %}
                                        <a href="{{ message.attachment.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-paperclip me-1"></i> {{ message.attachment.url|slice:"20:" }}
                                        </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                                <small class="opacity-75">
                                    {{ message.sender_name }} â€¢ {{ message.timestamp|date:"M d, H:i" }}
                                </small>
                            </div>
                        </div>
                        {% endif %}
                        {% empty %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <h5>No messages yet</h5>
                            <p>This conversation hasn't started yet.</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Message Input -->
                    {% if conversation.status == 'open' %}
                    <div class="border-top pt-3">
                        <!-- File Preview -->
                        <div id="file-preview" style="display: none;" class="mb-2 p-2 bg-light border rounded">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-paperclip me-2"></i>
                                    <span id="file-name"></span>
                                    <small id="file-size" class="text-muted ms-2"></small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <form id="message-form" class="d-flex">
                            <input type="file" id="file-input" style="display: none;" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="document.getElementById('file-input').click()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="text" id="message-input" class="form-control me-2" placeholder="Type your message...">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div class="border-top pt-3 text-center text-muted">
                        <i class="fas fa-lock me-2"></i>
                        This conversation is closed. Reopen to continue messaging.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebSocket connection indicator -->
<div id="connection-status" class="position-fixed bottom-0 end-0 m-3">
    <span class="badge bg-secondary">Connecting...</span>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const conversationId = '{{ conversation.id }}';
    const customerId = '{{ conversation.customer_id }}';
    const adminName = '{{ user.get_full_name|default:user.username }}';
    let currentStatus = '{{ conversation.status }}'; // Track current status dynamically
    let selectedFile = null; // Track selected file for upload
    
    // WebSocket connection
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsPath = wsScheme + '://' + window.location.host + '/ws/admin/dashboard/';
    const chatSocket = new WebSocket(wsPath);
    
    const connectionStatus = document.getElementById('connection-status');
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    
    // File input handler
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-size').textContent = `(${(file.size / 1024).toFixed(2)} KB)`;
                filePreview.style.display = 'block';
            }
        });
    }
    
    // Remove file function
    window.removeFile = function() {
        selectedFile = null;
        if (fileInput) fileInput.value = '';
        if (filePreview) filePreview.style.display = 'none';
    };
    
    // Upload file function
    async function uploadFile(file, senderType) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('customer_id', customerId);
        formData.append('sender_type', senderType);
        formData.append('sender_name', adminName);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));  // Add CSRF token to form data
        
        const response = await fetch('{% url "chat:upload_attachment" %}', {
            method: 'POST',
            body: formData
            // Don't set Content-Type header - browser will set it with boundary for multipart/form-data
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
        }
        
        return await response.json();
    }

    chatSocket.onopen = function(e) {
        connectionStatus.innerHTML = '<span class="badge bg-success">Connected</span>';
        setTimeout(() => connectionStatus.style.display = 'none', 2000);
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('WebSocket message:', data);  // Debug log
        
        if (data.type === 'new_message_notification' && data.customer_id === customerId) {
            // Add new message to the chat with attachment if present
            addMessageToChat(data.message, data.sender_type, data.sender_name, data.timestamp, data.attachment_url);
        } else if (data.type === 'admin_message_sent' && data.customer_id === customerId) {
            // Admin message was successfully sent and saved - add to UI
            addMessageToChat(data.message, data.sender_type, data.sender_name, data.timestamp, data.attachment_url);
        } else if (data.type === 'conversation_status_changed' && data.customer_id === customerId) {
            // Handle conversation status change
            currentStatus = data.status;
            if (data.status === 'closed') {
                addMessageToChat(`Conversation closed by ${data.closed_by}`, 'system', 'System', data.timestamp);
            } else if (data.status === 'open') {
                addMessageToChat(`Conversation reopened by ${data.reopened_by}`, 'system', 'System', data.timestamp);
            }
            updateUIForStatus(data.status);
        }
    };

    chatSocket.onclose = function(e) {
        connectionStatus.innerHTML = '<span class="badge bg-danger">Disconnected</span>';
        connectionStatus.style.display = 'block';
    };

    chatSocket.onerror = function(e) {
        connectionStatus.innerHTML = '<span class="badge bg-warning">Error</span>';
        connectionStatus.style.display = 'block';
    };

    // Handle message form submission
    if (messageForm) {
        messageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            
            // Handle file upload
            if (selectedFile) {
                try {
                    const uploadData = await uploadFile(selectedFile, 'admin');
                    const fileMessage = message || `ðŸ“Ž ${selectedFile.name}`;
                    
                    // Send message with attachment via WebSocket
                    chatSocket.send(JSON.stringify({
                        'type': 'admin_message',
                        'customer_id': customerId,
                        'message': fileMessage,
                        'sender_name': adminName,
                        'attachment_path': uploadData.attachment_path,  // Send path for DB storage
                        'attachment_url': uploadData.attachment_url      // Send URL for display
                    }));
                    
                    // Don't add immediately - wait for WebSocket confirmation
                    
                    // Clear inputs
                    removeFile();
                    messageInput.value = '';
                } catch (error) {
                    alert('Error uploading file: ' + error.message);
                }
            } else if (message) {
                // Send text message via WebSocket
                chatSocket.send(JSON.stringify({
                    'type': 'admin_message',
                    'customer_id': customerId,
                    'message': message,
                    'sender_name': adminName
                }));
                
                // Don't add immediately - wait for WebSocket confirmation
                messageInput.value = '';
            }
        });
    }

    function addMessageToChat(message, senderType, senderName, timestamp, attachmentUrl = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex ${senderType === 'admin' ? 'justify-content-end' : 'justify-content-start'}`;
        
        const bubbleDiv = document.createElement('div');
        let messageClass = 'message-customer';
        if (senderType === 'admin') messageClass = 'message-admin';
        else if (senderType === 'system') messageClass = 'message-system';
        
        bubbleDiv.className = `message-bubble ${messageClass}`;
        
        const date = new Date(timestamp);
        const timeString = date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        let attachmentHtml = '';
        if (attachmentUrl) {
            const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(attachmentUrl);
            if (isImage) {
                attachmentHtml = `
                    <div class="mt-2">
                        <a href="${attachmentUrl}" target="_blank">
                            <img src="${attachmentUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; cursor: pointer;" class="img-thumbnail" />
                        </a>
                    </div>
                `;
            } else {
                const fileName = attachmentUrl.split('/').pop();
                attachmentHtml = `
                    <div class="mt-2">
                        <a href="${attachmentUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-paperclip me-1"></i> ${escapeHtml(fileName)}
                        </a>
                    </div>
                `;
            }
        }
        
        bubbleDiv.innerHTML = `
            <div class="mb-1">${escapeHtml(message)}</div>
            ${attachmentHtml}
            <small class="opacity-75">${escapeHtml(senderName)} â€¢ ${timeString}</small>
        `;
        
        messageDiv.appendChild(bubbleDiv);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function toggleChatStatus() {
        const newStatus = currentStatus === 'open' ? 'closed' : 'open';
        
        if (newStatus === 'closed') {
            // Use WebSocket to close conversation for real-time updates
            chatSocket.send(JSON.stringify({
                'type': 'admin_close_conversation',
                'customer_id': customerId
            }));
        } else {
            // Use WebSocket to reopen conversation for real-time updates
            chatSocket.send(JSON.stringify({
                'type': 'admin_reopen_conversation',
                'customer_id': customerId
            }));
        }
    }
    
    function updateUIForStatus(status) {
        const statusBadge = document.querySelector('.badge');
        const toggleButton = document.querySelector('button[onclick="toggleChatStatus()"]');
        const messageForm = document.getElementById('message-form');
        const closedMessage = document.querySelector('.border-top.pt-3.text-center');
        
        if (statusBadge) {
            statusBadge.className = status === 'open' ? 'badge bg-success me-2' : 'badge bg-secondary me-2';
            statusBadge.textContent = status === 'open' ? 'Open' : 'Closed';
        }
        
        if (toggleButton) {
            toggleButton.textContent = status === 'open' ? 'Close Chat' : 'Reopen Chat';
        }
        
        if (messageForm && closedMessage) {
            if (status === 'open') {
                messageForm.style.display = 'flex';
                closedMessage.style.display = 'none';
            } else {
                messageForm.style.display = 'none';
                closedMessage.style.display = 'block';
            }
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Auto-scroll to bottom on page load
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
</script>
{% endblock %}